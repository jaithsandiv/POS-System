-- =============================================================
-- POS v3 (Updated for Inclusive Pricing, Promotions & Trial Licensing)
-- =============================================================

/* ---------------------------
   1. BUSINESS (single business row per installation)
   --------------------------- */
CREATE TABLE Business (
    business_id      INT IDENTITY(1,1) PRIMARY KEY, -- Single business (app logic uses id=1)
    business_name    NVARCHAR(200) NOT NULL,        -- Registered business name
    logo             VARBINARY(MAX),
    status           CHAR(1) DEFAULT 'A',          -- 'A' = Active, 'I' = Inactive
    
    -- TRIAL & LICENSING (for local one-time payment model)
    trial_start_date DATETIME2 NULL,               -- Set on first registration
    trial_end_date   DATETIME2 NULL,               -- trial_start + 3 days
    is_licensed      BIT DEFAULT 0,                -- 0 = trial/expired, 1 = paid & unlocked
    
    created_by       INT NULL,                     -- user_id who created (nullable)
    created_date     DATETIME2 NULL DEFAULT GETDATE(),
    updated_by       INT NULL,
    updated_date     DATETIME2 NULL DEFAULT GETDATE()
);

-- ---------------------------
-- 2. STORE (multi-location support)
-- ---------------------------
CREATE TABLE Store (
    store_id       INT IDENTITY(1,1) PRIMARY KEY, -- Branch/location id
    store_name     NVARCHAR(100) NOT NULL,
    phone          NVARCHAR(20),
    email          NVARCHAR(100),
    address        NVARCHAR(500),
    city           NVARCHAR(50),
    state          NVARCHAR(50),
    country        NVARCHAR(50),
    postal_code    NVARCHAR(20),
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

INSERT INTO Store (store_name, address, city, country, status) VALUES 
('Main Store', '123 Main St', 'Colombo', 'Sri Lanka', 'A');

-- ---------------------------
-- 3. USER, ROLE & PERMISSION
-- ---------------------------
CREATE TABLE Role (
    role_id        INT IDENTITY(1,1) PRIMARY KEY,
    role_name      NVARCHAR(100) NOT NULL,          -- e.g., 'Cashier', 'Manager', 'Admin'
    description    NVARCHAR(255) NULL,
    status         CHAR(1) DEFAULT 'A',             -- 'A'=Active, 'I'=Inactive
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

INSERT INTO Role (role_name, description, status, created_by)VALUES

('Admin', 'System administrator with full access', 'A', NULL),
('Cashier', 'Standard cashier for sales transactions', 'A', NULL);

CREATE TABLE RolePermission (
    role_id        INT NOT NULL FOREIGN KEY REFERENCES Role(role_id),
    permission_code NVARCHAR(100) NOT NULL,          -- e.g., 'SALE_CREATE', 'DISCOUNT_APPROVE'
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE(),
    PRIMARY KEY (role_id, permission_code)
);

CREATE TABLE [User] (
    user_id        INT IDENTITY(1,1) PRIMARY KEY,
    store_id       INT NOT NULL FOREIGN KEY REFERENCES Store(store_id),
    role_id        INT NULL FOREIGN KEY REFERENCES Role(role_id),
    full_name      NVARCHAR(100) NOT NULL,
    username       NVARCHAR(100) UNIQUE NOT NULL,
    email          NVARCHAR(100) UNIQUE NOT NULL,
    phone          NVARCHAR(20),
    password_hash  NVARCHAR(255) NOT NULL,
    pin_code       NVARCHAR(6),            -- required for discount approval
    is_super_admin BIT DEFAULT 0,          -- vendor account; bypasses trial lock
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

INSERT INTO [User] (store_id, role_id, full_name, username, email, phone, password_hash, pin_code, is_super_admin, status, created_by)
VALUES
(1, 1, 'ADMINISTRATOR', 'admin', 'admin@serendib.lk', '012-345-6789', '$2a$11$ypBkOii4sXOcuhgNYDEGku3qu9SL65L5vBjZuxFwAocMPx35I.z1O', '123456', 1, 'A', NULL); -- Super Admin username:admin password:password

-- ---------------------------
-- 4. PRODUCT CATALOG
-- ---------------------------
CREATE TABLE Category (
    category_id    INT IDENTITY(1,1) PRIMARY KEY,
    category_name  NVARCHAR(100) NOT NULL,       -- unique name per store
    status         CHAR(1) DEFAULT 'A',          -- 'A'=Active, 'I'=Inactive
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE Brand (
    brand_id       INT IDENTITY(1,1) PRIMARY KEY,
    brand_name     NVARCHAR(100) NOT NULL,
    supplier_id    INT NULL FOREIGN KEY REFERENCES Supplier(supplier_id), -- Link to Supplier
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE Unit (
    unit_id        INT IDENTITY(1,1) PRIMARY KEY,
    code           NVARCHAR(10) NOT NULL,   -- e.g., PCS, KG
    name           NVARCHAR(50) NOT NULL,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE Product (
    product_id     INT IDENTITY(1,1) PRIMARY KEY,
    product_name   NVARCHAR(200) NOT NULL,  -- required
    product_code   NVARCHAR(50) NOT NULL UNIQUE, -- required, unique SKU
    barcode        NVARCHAR(100),
    product_type   NVARCHAR(20) DEFAULT 'Standard', -- Standard/Combo/Digital
    category_id    INT NULL FOREIGN KEY REFERENCES Category(category_id),
    brand_id       INT NULL FOREIGN KEY REFERENCES Brand(brand_id),
    unit_id        INT NOT NULL FOREIGN KEY REFERENCES Unit(unit_id), -- required
    purchase_cost  DECIMAL(14,2) NULL,
    selling_price  DECIMAL(14,2) NOT NULL,   -- INCLUSIVE of all taxes (final consumer price)
    stock_quantity DECIMAL(14,3) DEFAULT 0,  -- maintained by app
    expiry_date    DATE NULL,
    manufacture_date DATE NULL,
    description    NVARCHAR(MAX) NULL,
    image          VARBINARY(MAX),
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

-- PROMOTIONS (campaign-based, with per-product discounts)
CREATE TABLE Promotion (
    promotion_id     INT IDENTITY(1,1) PRIMARY KEY,
    promotion_name   NVARCHAR(100) NOT NULL,        -- e.g., 'New Year Sale 2025'
    description      NVARCHAR(255) NULL,
    start_date       DATETIME2 NOT NULL,            -- inclusive
    end_date         DATETIME2 NOT NULL,            -- inclusive
    status           CHAR(1) DEFAULT 'A',           -- 'A'=Active, 'I'=Inactive
    created_by       INT NULL,
    created_date     DATETIME2 DEFAULT GETDATE(),
    updated_by       INT NULL,
    updated_date     DATETIME2 DEFAULT GETDATE()
);

CREATE TABLE ProductPromotion (
    promotion_product_id INT IDENTITY(1,1) PRIMARY KEY,
    promotion_id         INT NOT NULL FOREIGN KEY REFERENCES Promotion(promotion_id) ON DELETE CASCADE,
    product_id           INT NOT NULL FOREIGN KEY REFERENCES Product(product_id),
    promotion_type       NVARCHAR(20) NOT NULL,     -- 'PERCENTAGE' or 'FIXED_AMOUNT'
    discount_value       DECIMAL(10,2) NOT NULL,    -- e.g., 15.00 (%) or 100.00 (LKR off)
    status               CHAR(1) DEFAULT 'A',
    created_by           INT NULL,
    created_date         DATETIME2 DEFAULT GETDATE(),
    updated_by           INT NULL,
    updated_date         DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT UQ_PromotionProduct UNIQUE (promotion_id, product_id),
    CONSTRAINT CHK_PromotionType CHECK (promotion_type IN ('PERCENTAGE', 'FIXED_AMOUNT'))
);

-- ---------------------------
-- 5. CUSTOMER
-- ---------------------------
CREATE TABLE CustomerGroup (
    group_id       INT IDENTITY(1,1) PRIMARY KEY,
    group_name     NVARCHAR(100) NOT NULL,
    discount_percent DECIMAL(5,2) DEFAULT 0,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE Customer (
    customer_id    INT IDENTITY(1,1) PRIMARY KEY,
    group_id       INT NULL FOREIGN KEY REFERENCES CustomerGroup(group_id),
    full_name      NVARCHAR(100) NOT NULL,
    company_name   NVARCHAR(100) NULL,
    email          NVARCHAR(100) NULL,
    phone          NVARCHAR(20) NULL,
    address        NVARCHAR(500) NULL,
    city           NVARCHAR(50) NULL,
    state          NVARCHAR(50) NULL,
    country        NVARCHAR(50) NULL,
    postal_code    NVARCHAR(20) NULL,
    credit_limit   DECIMAL(14,2) DEFAULT 0,  -- allowed credit limit
    credit_balance DECIMAL(14,2) DEFAULT 0,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

INSERT INTO Customer (full_name, status, created_by)
VALUES
('Walk-In Customer', 'A', NULL);

-- ---------------------------
-- 6. SUPPLIER
-- ---------------------------
CREATE TABLE Supplier (
    supplier_id    INT IDENTITY(1,1) PRIMARY KEY,
    supplier_name  NVARCHAR(100) NOT NULL,
    company_name   NVARCHAR(100) NULL,
    email          NVARCHAR(100) NULL,
    phone          NVARCHAR(20) NULL,
    address        NVARCHAR(500) NULL,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

-- ---------------------------
-- 7. SALES & PAYMENTS (core POS)
-- ---------------------------
CREATE TABLE Sale (
    sale_id        INT IDENTITY(1,1) PRIMARY KEY,
    store_id       INT NOT NULL FOREIGN KEY REFERENCES Store(store_id),
    sale_type      NVARCHAR(20) NOT NULL,        -- 'SALE','DRAFT','QUOTATION'
    invoice_number NVARCHAR(50) NULL,    
    quotation_number NVARCHAR(50) NULL,
    customer_id    INT NULL FOREIGN KEY REFERENCES Customer(customer_id),
    biller_id      INT NOT NULL FOREIGN KEY REFERENCES [User](user_id), -- cashier
    total_items    INT NOT NULL,
    total_amount   DECIMAL(14,2) NOT NULL,       -- Σ(SaleItem.subtotal)
    discount_type  NVARCHAR(20) NOT NULL,    
    discount_value DECIMAL(10,2) NOT NULL,    -- sale-level discount
    grand_total    DECIMAL(14,2) NOT NULL,       -- total_amount - discount_amount
    
    total_paid     DECIMAL(14,2) NOT NULL DEFAULT 0, -- Total amount received from all payments
    change_due      DECIMAL(14,2) NOT NULL DEFAULT 0, -- Change to be given back (total_paid - grand_total)
    
    payment_status NVARCHAR(20) DEFAULT 'PENDING', -- 'PAID','PARTIAL','CREDIT'
    sale_status    NVARCHAR(20) DEFAULT 'COMPLETED', -- 'CANCELLED','CONVERTED'
    order_type     NVARCHAR(20) NULL,            -- KOT: 'TAKE_AWAY','DINE_IN'
    table_number   NVARCHAR(20) NULL,      
    notes          NVARCHAR(MAX) NULL,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE SaleItem (
    sale_item_id   INT IDENTITY(1,1) PRIMARY KEY,
    sale_id        INT NOT NULL FOREIGN KEY REFERENCES Sale(sale_id) ON DELETE CASCADE,
    product_id     INT NOT NULL FOREIGN KEY REFERENCES Product(product_id),
    product_name   NVARCHAR(200) NOT NULL,      -- denormalized snapshot
    product_code   NVARCHAR(50) NULL,
    unit           NVARCHAR(50) NULL,
    unit_price     DECIMAL(14,2) NOT NULL,      -- base selling_price (inclusive, pre-discount)
    quantity       DECIMAL(10,3) NOT NULL,
    discount_type  NVARCHAR(20) NOT NULL,     -- 'PERCENTAGE' or 'FIXED_AMOUNT'
    discount_value DECIMAL(10,2) NOT NULL,    -- e.g., 15.00 (%) or 100.00 (LKR off) item-level discount (from promo)
    subtotal       DECIMAL(14,2) NOT NULL,      -- (unit_price * qty) - discount_amount
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE Payment (
    payment_id             INT IDENTITY(1,1) PRIMARY KEY,
    sale_id                INT NOT NULL FOREIGN KEY REFERENCES Sale(sale_id) ON DELETE CASCADE,
    
    -- Core Payment Info
    payment_method         NVARCHAR(50) NOT NULL,  
    amount                 DECIMAL(14,2) NOT NULL, -- The amount received for this specific payment
    
    -- Card Specific (Secure & Auditable)
    card_last_four_digits   NVARCHAR(4) NULL,     -- RENAMED: Only store last 4 digits
    card_holder_name        NVARCHAR(100) NULL,   -- KEPT: Non-sensitive
    card_transaction_number NVARCHAR(100) NULL,   -- KEPT: This is the Auth Code / Transaction ID
    card_type               NVARCHAR(50) NULL,    -- KEPT: e.g., 'Visa', 'MasterCard'

    -- Bank Transfer Specific
    bank_reference_number   NVARCHAR(100) NULL,        

    -- Audit
    status                 CHAR(1) DEFAULT 'A',
    created_by             INT NULL,
    created_date           DATETIME2 NULL DEFAULT GETDATE(),
    updated_by             INT NULL,
    updated_date           DATETIME2 NULL DEFAULT GETDATE(),

    -- Constraint
    CONSTRAINT CHK_PaymentMethod CHECK (payment_method IN ('CASH', 'CARD', 'BANK_TRANSFER', 'CREDIT'))
);

-- Creates a number generator for Invoices
CREATE SEQUENCE InvoiceNumberSequence
    AS INT
    START WITH 1
    INCREMENT BY 1;

-- Creates a number generator for Quotations
CREATE SEQUENCE QuotationNumberSequence
    AS INT
    START WITH 1
    INCREMENT BY 1;

-- ---------------------------
-- 8. RETURNS
-- ---------------------------
CREATE TABLE SaleReturn (
    return_id      INT IDENTITY(1,1) PRIMARY KEY,
    sale_id        INT NOT NULL FOREIGN KEY REFERENCES Sale(sale_id),
    total_amount   DECIMAL(14,2) NOT NULL,
    reason         NVARCHAR(200) NULL,
    processed_by   INT NULL FOREIGN KEY REFERENCES [User](user_id),
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE ReturnItem (
    return_item_id INT IDENTITY(1,1) PRIMARY KEY,
    return_id      INT NOT NULL FOREIGN KEY REFERENCES SaleReturn(return_id) ON DELETE CASCADE,
    sale_item_id   INT NOT NULL FOREIGN KEY REFERENCES SaleItem(sale_item_id),
    product_id     INT NOT NULL,
    quantity       DECIMAL(10,3) NOT NULL,
    refund_amount  DECIMAL(14,2) NOT NULL,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

-- ---------------------------
-- 9. TABLE MANAGEMENT (KOT)
-- ---------------------------
CREATE TABLE [Table] (
    table_id       INT IDENTITY(1,1) PRIMARY KEY,
    table_number   NVARCHAR(20) NOT NULL,       -- displayed table identifier
    capacity       INT NULL,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

-- ---------------------------
-- 10. SYSTEM SETTINGS & BARCODE PRINT
-- ---------------------------
CREATE TABLE SystemSetting (
    setting_key    NVARCHAR(100) PRIMARY KEY,   -- e.g. 'kot_enabled'
    setting_value  NVARCHAR(MAX) NULL,
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

CREATE TABLE BarcodePrint (
    print_id       INT IDENTITY(1,1) PRIMARY KEY,
    product_id     INT NOT NULL FOREIGN KEY REFERENCES Product(product_id),
    quantity_printed INT NOT NULL,
    include_name   BIT DEFAULT 1,
    include_price  BIT DEFAULT 1,
    include_expiry BIT DEFAULT 0,
    include_manufacture BIT DEFAULT 0,
    include_promo_price BIT DEFAULT 0,
    printed_by     INT NULL FOREIGN KEY REFERENCES [User](user_id),
    status         CHAR(1) DEFAULT 'A',
    created_by     INT NULL,
    created_date   DATETIME2 NULL DEFAULT GETDATE(),
    updated_by     INT NULL,
    updated_date   DATETIME2 NULL DEFAULT GETDATE()
);

-- ---------------------------
-- 11. SYSTEM LOG
-- ---------------------------
CREATE TABLE SystemLog (
    log_id         BIGINT IDENTITY(1,1) PRIMARY KEY,
    log_type       NVARCHAR(20) NOT NULL,       -- 'INFO','WARNING','ERROR','AUDIT'
    source         NVARCHAR(100) NOT NULL,      -- e.g. 'POS','STOCK','LOGIN'
    reference_id   INT NULL,                    -- optional business reference (sale, adj, etc)
    message        NVARCHAR(MAX) NOT NULL,
    stack_trace    NVARCHAR(MAX) NULL,
    user_id        INT NULL FOREIGN KEY REFERENCES [User](user_id),
    created_date   DATETIME2 DEFAULT GETDATE()
);

-- ---------------------------
-- 12. DEFAULT SYSTEM SETTINGS
-- ---------------------------
INSERT INTO SystemSetting (setting_key, setting_value, status) VALUES
('ENABLE_THERMAL_PRINT', 'True', 'A'),
('ENABLE_A4_PRINT', 'False', 'A'),
('auto_print', 'True', 'A'),
('thermal_printer_name', 'Microsoft Print to PDF', 'A'),
('kot_enabled', 'False', 'A'),
('kot_printer_name', '', 'A'),
('invoice_footer', 'Thank You For Your Business!', 'A'),
('stock_check_enabled', 'True', 'A'),
('store_website', '', 'A');






USE [POS-db]
GO

-- =============================================
-- 1. Dashboard KPI Cards
-- =============================================
CREATE OR ALTER PROCEDURE usp_GetDashboardKpis
    @FromDate DATETIME2,
    @ToDate DATETIME2
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @TotalSales DECIMAL(14,2);
    DECLARE @TotalTransactions INT;
    DECLARE @TotalSalesReturn DECIMAL(14,2);
    DECLARE @InvoiceDue DECIMAL(14,2);
    DECLARE @TotalCashSales DECIMAL(14,2);
    DECLARE @LowStockCount INT;

    -- 1. Total Sales & Transactions (Active Sales)
    SELECT 
        @TotalSales = ISNULL(SUM(grand_total), 0),
        @TotalTransactions = COUNT(sale_id)
    FROM Sale
    WHERE sale_type = 'SALE' 
      AND status = 'A' 
      AND created_date BETWEEN @FromDate AND @ToDate;

    -- 2. Total Sales Return
    SELECT 
        @TotalSalesReturn = ISNULL(SUM(total_amount), 0)
    FROM SaleReturn
    WHERE status = 'A' 
      AND created_date BETWEEN @FromDate AND @ToDate;

    -- 3. Invoice Due (Outstanding balance for sales generated in this period)
    SELECT 
        @InvoiceDue = ISNULL(SUM(grand_total - total_paid), 0)
    FROM Sale
    WHERE sale_type = 'SALE' 
      AND status = 'A' 
      AND payment_status IN ('PENDING', 'PARTIAL', 'CREDIT')
      AND created_date BETWEEN @FromDate AND @ToDate;

    -- 4. Total Cash Sales (Actual Cash received in this period)
    SELECT 
        @TotalCashSales = ISNULL(SUM(amount), 0)
    FROM Payment
    WHERE payment_method = 'CASH'
      AND status = 'A'
      AND created_date BETWEEN @FromDate AND @ToDate;

    -- 5. Low Stock Items (Snapshot - items with <= 10 qty)
    SELECT 
        @LowStockCount = COUNT(product_id)
    FROM Product
    WHERE status = 'A' 
      AND stock_quantity <= 10;

    -- Return Single Row Result
    SELECT 
        @TotalSales AS TotalSales,
        @TotalTransactions AS TotalTransactions,
        (@TotalSales - @TotalSalesReturn) AS NetSales,
        @InvoiceDue AS InvoiceDue,
        @TotalSalesReturn AS TotalSalesReturn,
        @TotalCashSales AS TotalCashSales,
        CASE WHEN @TotalTransactions > 0 THEN @TotalSales / @TotalTransactions ELSE 0 END AS AvgSaleValue,
        @LowStockCount AS LowStockCount;
END;
GO

-- =============================================
-- 2. Sales Trend Chart (Daily Sales)
-- =============================================
CREATE OR ALTER PROCEDURE usp_GetDashboardSalesTrend
    @FromDate DATETIME2,
    @ToDate DATETIME2
AS
BEGIN
    SELECT 
        CAST(created_date AS DATE) AS Argument, -- Date for X-Axis
        SUM(grand_total) AS Value               -- Amount for Y-Axis
    FROM Sale
    WHERE sale_type = 'SALE' 
      AND status = 'A' 
      AND created_date BETWEEN @FromDate AND @ToDate
    GROUP BY CAST(created_date AS DATE)
    ORDER BY Argument;
END;
GO

-- =============================================
-- 3. Top Products Chart (Top 5 by Qty)
-- =============================================
CREATE OR ALTER PROCEDURE usp_GetDashboardTopProducts
    @FromDate DATETIME2,
    @ToDate DATETIME2
AS
BEGIN
    SELECT TOP 5
        p.product_name AS Argument,
        SUM(si.quantity) AS Value
    FROM SaleItem si
    JOIN Sale s ON si.sale_id = s.sale_id
    JOIN Product p ON si.product_id = p.product_id
    WHERE s.sale_type = 'SALE' 
      AND s.status = 'A' 
      AND s.created_date BETWEEN @FromDate AND @ToDate
    GROUP BY p.product_name
    ORDER BY Value DESC;
END;
GO



USE [POS-db]
GO

-- =============================================
-- 1. Get Customer Transactions (Sales, Payments, Returns)
-- =============================================
CREATE OR ALTER PROCEDURE usp_GetCustomerTransactions
    @CustomerId INT,
    @StartDate DATETIME2,
    @EndDate DATETIME2,
    @StoreId INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    -- Combine Sales, Payments, and Returns into a single timeline
    SELECT 
        T.TransactionDate,
        T.InvoiceNumber,
        T.TransactionType,
        T.Description,
        T.Debit,   -- Amount Owed (Invoice)
        T.Credit,  -- Amount Paid (Payment/Return)
        T.Status
    FROM (
        -- 1. Sales (Invoices) -> Debit
        SELECT 
            created_date AS TransactionDate,
            invoice_number AS InvoiceNumber,
            'INVOICE' AS TransactionType,
            'Sale #' + CAST(sale_id AS NVARCHAR(20)) AS Description,
            grand_total AS Debit,
            0 AS Credit,
            payment_status AS Status
        FROM Sale
        WHERE customer_id = @CustomerId
          AND sale_type = 'SALE'
          AND status = 'A'
          AND created_date BETWEEN @StartDate AND @EndDate
          AND (@StoreId IS NULL OR store_id = @StoreId)

        UNION ALL

        -- 2. Payments -> Credit
        SELECT 
            p.created_date AS TransactionDate,
            s.invoice_number AS InvoiceNumber,
            'PAYMENT' AS TransactionType,
            p.payment_method AS Description,
            0 AS Debit,
            p.amount AS Credit,
            'COMPLETED' AS Status
        FROM Payment p
        JOIN Sale s ON p.sale_id = s.sale_id
        WHERE s.customer_id = @CustomerId
          AND p.status = 'A'
          AND p.created_date BETWEEN @StartDate AND @EndDate
          AND (@StoreId IS NULL OR s.store_id = @StoreId)

        UNION ALL

        -- 3. Returns -> Credit (Refunds reduce debt)
        SELECT 
            sr.created_date AS TransactionDate,
            s.invoice_number AS InvoiceNumber,
            'RETURN' AS TransactionType,
            ISNULL(sr.reason, 'Return') AS Description,
            0 AS Debit,
            sr.total_amount AS Credit,
            'COMPLETED' AS Status
        FROM SaleReturn sr
        JOIN Sale s ON sr.sale_id = s.sale_id
        WHERE s.customer_id = @CustomerId
          AND sr.status = 'A'
          AND sr.created_date BETWEEN @StartDate AND @EndDate
          AND (@StoreId IS NULL OR s.store_id = @StoreId)
    ) AS T
    ORDER BY T.TransactionDate DESC;
END;
GO

-- =============================================
-- 2. Get Customer Account Summary
-- =============================================
CREATE OR ALTER PROCEDURE usp_GetCustomerAccountSummary
    @CustomerId INT,
    @StartDate DATETIME2,
    @EndDate DATETIME2,
    @StoreId INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @OpeningBalance DECIMAL(14,2) = 0;
    DECLARE @TotalInvoice DECIMAL(14,2) = 0;
    DECLARE @TotalPaid DECIMAL(14,2) = 0;
    DECLARE @TotalReturn DECIMAL(14,2) = 0;
    DECLARE @CurrentBalance DECIMAL(14,2) = 0;
    DECLARE @CreditLimit DECIMAL(14,2) = 0;

    -- Get Current Balance & Credit Limit from Customer Table
    SELECT 
        @CurrentBalance = ISNULL(credit_balance, 0),
        @CreditLimit = ISNULL(credit_limit, 0)
    FROM Customer
    WHERE customer_id = @CustomerId;

    -- Calculate Totals within Date Range
    -- Total Invoiced
    SELECT @TotalInvoice = ISNULL(SUM(grand_total), 0)
    FROM Sale
    WHERE customer_id = @CustomerId
      AND sale_type = 'SALE'
      AND status = 'A'
      AND created_date BETWEEN @StartDate AND @EndDate
      AND (@StoreId IS NULL OR store_id = @StoreId);

    -- Total Paid
    SELECT @TotalPaid = ISNULL(SUM(p.amount), 0)
    FROM Payment p
    JOIN Sale s ON p.sale_id = s.sale_id
    WHERE s.customer_id = @CustomerId
      AND p.status = 'A'
      AND p.created_date BETWEEN @StartDate AND @EndDate
      AND (@StoreId IS NULL OR s.store_id = @StoreId);

    -- Total Returned
    SELECT @TotalReturn = ISNULL(SUM(sr.total_amount), 0)
    FROM SaleReturn sr
    JOIN Sale s ON sr.sale_id = s.sale_id
    WHERE s.customer_id = @CustomerId
      AND sr.status = 'A'
      AND sr.created_date BETWEEN @StartDate AND @EndDate
      AND (@StoreId IS NULL OR s.store_id = @StoreId);

    -- Back-calculate Opening Balance
    -- CurrentBalance = OpeningBalance + (Invoiced - Paid - Returned)
    -- OpeningBalance = CurrentBalance - (Invoiced - Paid - Returned)
    SET @OpeningBalance = @CurrentBalance - (@TotalInvoice - @TotalPaid - @TotalReturn);

    SELECT 
        @OpeningBalance AS OpeningBalance,
        @TotalInvoice AS TotalInvoice,
        @TotalPaid AS TotalPaid,
        @TotalReturn AS TotalReturn,
        @CurrentBalance AS CurrentBalance,
        @CreditLimit AS CreditLimit;
END;
GO

-- =============================================
-- 3. Get Supplier Transactions (Placeholder)
-- =============================================
CREATE OR ALTER PROCEDURE usp_GetSupplierTransactions
    @SupplierId INT,
    @StartDate DATETIME2,
    @EndDate DATETIME2,
    @StoreId INT = NULL
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Return empty result set with correct schema
    SELECT 
        CAST(NULL AS DATETIME2) AS TransactionDate,
        CAST(NULL AS NVARCHAR(50)) AS InvoiceNumber,
        CAST(NULL AS NVARCHAR(20)) AS TransactionType,
        CAST(NULL AS NVARCHAR(100)) AS Description,
        CAST(0 AS DECIMAL(14,2)) AS Debit,
        CAST(0 AS DECIMAL(14,2)) AS Credit,
        CAST(NULL AS NVARCHAR(20)) AS Status
    WHERE 1 = 0;
END;
GO
